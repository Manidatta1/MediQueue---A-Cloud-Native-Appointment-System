apiVersion: apps/v1
kind: Deployment
metadata:
  name: airflow-service
  namespace: {{ .Values.namespace }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: airflow
  template:
    metadata:
      labels:
        app: airflow
    spec:
      containers:
        - name: airflow
          image: {{ .Values.airflow.image }}
          ports:
            - containerPort: 8080
          env:
            - name: AIRFLOW__CORE__LOAD_EXAMPLES
              value: "False"
            - name: AIRFLOW__CORE__EXECUTOR
              value: "SequentialExecutor"
            - name: AIRFLOW__CORE__SQL_ALCHEMY_CONN
              value: "sqlite:////opt/airflow/airflow.db"
            - name: AIRFLOW__WEBSERVER__DEFAULT_UI_TIMEZONE
              value: "America/Chicago"

          # âœ… Command to initialize DB, create user, and start Airflow webserver + scheduler
          command:
            - /bin/bash
            - -c
            - |
              airflow db init &&
              airflow users create -u admin -p admin -f Air -l Flow -r Admin -e admin@example.com &&
              airflow webserver & airflow scheduler

          # (Optional: if you plan to mount DAGs later, uncomment below)
          # volumeMounts:
          #   - name: dags
          #     mountPath: /opt/airflow/dags

      # (Optional volume for DAGs, only if you have a ConfigMap)
      # volumes:
      #   - name: dags
      #     configMap:
      #       name: airflow-dags
