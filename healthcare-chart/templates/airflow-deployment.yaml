apiVersion: apps/v1
kind: Deployment
metadata:
  name: airflow
  namespace: {{ .Values.namespace }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: airflow
  template:
    metadata:
      labels:
        app: airflow
    spec:
      containers:
        - name: airflow
          image: {{ .Values.airflow.image }}
          ports:
            - containerPort: 8080
          env:
            - name: AIRFLOW__CORE__EXECUTOR
              value: "LocalExecutor"
            - name: AIRFLOW__CORE__SQL_ALCHEMY_CONN
              value: "postgresql+psycopg2://healthcare_admin:healthcareadmin123@postgres-service:5432/healthcare"
            - name: AIRFLOW__DATABASE__SQL_ALCHEMY_CONN
              value: "postgresql+psycopg2://healthcare_admin:healthcareadmin123@postgres-service:5432/healthcare"
            - name: AIRFLOW__CORE__FERNET_KEY
              value: "3FobKnxY6fB3DL8RZhtz1i2TTuCPk42HZVnbH8ogOuc="
            - name: AIRFLOW__CORE__LOAD_EXAMPLES
              value: "False"
            - name: AIRFLOW__WEBSERVER__DEFAULT_UI_TIMEZONE
              value: "America/Chicago"
          command:
            - /bin/bash
            - -c
            - |
              set -e
              echo "ðŸ”¹ Ensuring Airflow DB exists..." && \
              PGPASSWORD=healthcareadmin123 psql -h postgres-service -U healthcare_admin -tc "SELECT 1 FROM pg_database WHERE datname='healthcare'" | grep -q 1 || \
                PGPASSWORD=healthcareadmin123 psql -h postgres-service -U healthcare_admin -c "CREATE DATABASE healthcare;" && \
              echo "âœ… DB ready, migrating schema..." && \
              airflow db migrate && \
              echo "ðŸ”¹ Creating admin user (ignore if exists)..." && \
              airflow users create -u admin -p admin -f Air -l Flow -r Admin -e admin@example.com || true && \
              echo "ðŸš€ Starting Airflow webserver and scheduler..." && \
              (airflow webserver -p 8080 &) && \
              exec airflow scheduler
      restartPolicy: Always
