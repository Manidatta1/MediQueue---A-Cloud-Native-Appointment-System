apiVersion: apps/v1
kind: Deployment
metadata:
  name: airflow-service
  namespace: {{ .Values.namespace }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: airflow
  template:
    metadata:
      labels:
        app: airflow
    spec:
      containers:
        - name: airflow
          image: {{ .Values.airflow.image }}
          ports:
            - containerPort: 8080
          env:
            - name: AIRFLOW__CORE__LOAD_EXAMPLES
              value: "False"
            - name: AIRFLOW__CORE__EXECUTOR
              value: "SequentialExecutor"
            - name: AIRFLOW__CORE__SQL_ALCHEMY_CONN
              value: "sqlite:////opt/airflow/airflow.db"
            - name: AIRFLOW__WEBSERVER__DEFAULT_UI_TIMEZONE
              value: "America/Chicago"

          # âœ… Ensures Airflow stays running and starts all components
          command:
            - /bin/bash
            - -c
            - |
              echo "Initializing Airflow DB..." && \
              airflow db init && \
              echo "Creating admin user (ignore if exists)..." && \
              airflow users create -u admin -p admin -f Air -l Flow -r Admin -e admin@example.com || true && \
              echo "Starting Airflow webserver..." && \
              airflow webserver -p 8080 -D && \
              echo "Starting Airflow scheduler..." && \
              exec airflow scheduler

          # (Optional) Uncomment if you want to mount DAGs later from ConfigMap
          # volumeMounts:
          #   - name: dags
          #     mountPath: /opt/airflow/dags

      # (Optional) ConfigMap for DAGs
      # volumes:
      #   - name: dags
      #     configMap:
      #       name: airflow-dags
