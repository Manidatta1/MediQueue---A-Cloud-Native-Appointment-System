apiVersion: apps/v1
kind: Deployment
metadata:
  name: airflow-service
  namespace: {{ .Values.namespace }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: airflow
  template:
    metadata:
      labels:
        app: airflow
    spec:
      containers:
        - name: airflow
          image: {{ .Values.airflow.image }}
          ports:
            - containerPort: 8080
          env:
            {{- range .Values.airflow.env }}
            - name: {{ .name }}
              value: {{ .value | quote }}
            {{- end }}
          command:
            - /bin/bash
            - -c
            - |
              echo "ðŸ”¹ Checking if Airflow DB exists..." && \
              PGPASSWORD=healthcareadmin123 psql -h postgres-service -U healthcare_admin -tc "SELECT 1 FROM pg_database WHERE datname='airflow_db'" | grep -q 1 || \
                PGPASSWORD=healthcareadmin123 psql -h postgres-service -U healthcare_admin -c "CREATE DATABASE airflow_db;" && \
              echo "âœ… Database ready." && \
              echo "ðŸ”¹ Migrating schema..." && \
              airflow db migrate && \
              echo "ðŸ”¹ Creating admin user (ignore if exists)..." && \
              airflow users create -u admin -p admin -f Air -l Flow -r Admin -e admin@example.com || true && \
              echo "ðŸš€ Starting Airflow webserver on port 8080..." && \
              airflow webserver -p 8080 -D && \
              echo "ðŸŒ€ Starting Airflow scheduler with restart loop..." && \
              while true; do airflow scheduler; sleep 10; done
      restartPolicy: Always



          # (Optional) Uncomment if you want to mount DAGs later from ConfigMap
          # volumeMounts:
          #   - name: dags
          #     mountPath: /opt/airflow/dags

      # (Optional) ConfigMap for DAGs
      # volumes:
      #   - name: dags
      #     configMap:
      #       name: airflow-dags
